
##  RPushbullet -- R interface to Pushbullet libraries
##
##  Copyright (C) 2014  Dirk Eddelbuettel <edd@debian.org>
##
##  This file is part of RPushbullet.
##
##  RPushbullet is free software: you can redistribute it and/or modify
##  it under the terms of the GNU General Public License as published by
##  the Free Software Foundation, either version 2 of the License, or
##  (at your option) any later version.
##
##  RPushbullet is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU General Public License for more details.
##
##  You should have received a copy of the GNU General Public License
##  along with RPushbullet.  If not, see <http://www.gnu.org/licenses/>.

.pkgenv <- new.env(parent=emptyenv())

.onAttach <- function(libname, pkgname) {
    packageStartupMessage("Attaching RPushbullet version ",
                          packageDescription("RPushbullet")$Version, ".")

    curl <- Sys.which("curl")
    if (curl == "") {
        warning("No curl binary found in your path. Please consider installing curl.")
    } else {
        assign("curl", curl, envir=.pkgenv)
    }
    
    dotfile <- "~/.rpushbullet.json"
    if (file.exists(dotfile)) {
        packageStartupMessage("Reading ", dotfile)
        pb <- fromJSON(dotfile)
        assign("pb", pb, envir=.pkgenv)
        options("rpushbullet.key" = pb[["key"]])
        options("rpushbullet.devices" =
                ifelse("devices" %in% names(pb), pb[["devices"]],0))
        options("rpushbullet.defaultdevice" =
                ifelse("defaultdevice" %in% names(pb), pb[["defaultdevice"]], 0))
    } else {
        txt <- paste("No file", dotfile, "found.\nConsider placing the",
                     "Pushbullet API key and your device id(s) there.")
        packageStartupMessage(txt)
        assign("pb", NULL, envir=.pkgenv)
    }
}

.getKey <- function() {
    getOption("rpushbullet.key",                # retrieve as option, 
              ifelse(!is.null(.pkgenv$pb),      # else try environment
                     .pkgenv$pb[["key"]],       # and use it, or signal error
                     stop(paste("Neither option 'rpushbullet.key' nor entry in",
                                "package environment found. Aborting."), call.=FALSE)))
}

.getDeviceList <- function(apikey = .getKey())
{
    curl <- .getCurl()
    pburl <- "https://api.pushbullet.com/v2/devices"
    txt <- sprintf('%s -u %s: %s',curl, apikey, pburl)
    result <- fromJSON(system(txt, intern=TRUE))
    result
}

.getDevices <- function() {
    getOption("rpushbullet.devices",       	# retrieve as option, 
                if(!is.null(.pkgenv$pb)){ 	# else try environment
                    if("devices" %in% names(.pkgenv$pb)){
                        .pkgenv$pb[["devices"]]
                    }
                })
    if(getOption("rpushbullet.devices") == 0){
        result <- .getDeviceList()
        sapply(result$devices, FUN = function(x){ x$iden })
    }
}

.getDefaultDevice <- function() {
    getOption("rpushbullet.defaultdevice",     	# retrieve as option, 
              ifelse(!is.null(.pkgenv$pb),	# else try environment
                     .pkgenv$pb[["defaultdevice"]], # and use it, or return zero
                     0))                            # as code for all devices
}

.getCurl <- function() {
    curl <- .pkgenv$curl
    if (curl == "") stop(paste("No curl binary registered. ",
                               "Install curl, and restart R and reload package"),
                         call.=FALSE)
    curl
}

.getNames <- function() {
    getOption("rpushbullet.names",       	# retrieve as option, 
              ifelse(!is.null(.pkgenv$pb),	# else try environment
                     .pkgenv$pb[["names"]],   # and use it, or signal error
                     stop(paste("Neither option 'rpushbullet.names' nor entry in",
                                "package environment found. Aborting."), call.=FALSE)))
}

.getUploadRequest <- function(file.name,file.type="img/png",apikey = .getKey()) {
    
    curl <- .getCurl()
    pburl <- "https://api.pushbullet.com/v2/upload-request"
    
    txt <- sprintf('%s -u %s: %s -d file_name=%s -d file_type=%s',curl, apikey, pburl, file.name, file.type)
    
    result <- fromJSON(system(txt,intern=TRUE))
    result
}

.getContacts <- function(apikey = .getKey()) {
    curl <- .getCurl()
    pburl <- "https://api.pushbullet.com/v2/contacts"
    
    txt <- sprintf('%s -u %s: %s',curl, apikey, pburl)
    result <- fromJSON(system(txt, intern=TRUE))
    result
}

.getDeviceId <- function(nickname)
{
    devicelist<-.getDeviceList()
    if(missing(nickname)) {
        sapply(devicelist$devices, FUN = function(x){ x$iden })
    } else {
        result<-sapply(devicelist$devices, FUN=function(x){ifelse(x$nickname %in% nickname, x$iden, NA)})
        result[!is.na(result)]
    }
    
}

## Not currently using, but could be handy:
#.getContactId <- function(email)
#{
#    contact.list<-.getContacts()
#    if(missing(email))
#    {
#        sapply(contact.list$contacts, FUN = function(x){x$iden})
#    } else {
#        result<-sapply(contact.list$contacts, FUN = function(x){ifelse(x$email %in% email, x$iden, NA)})
#        result[!is.na(result)]
#    }
#}
